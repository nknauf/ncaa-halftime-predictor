<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NCAA Halftime Predictor</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    h1 { margin-bottom: 6px; }
    h2 { margin-top: 40px; }
    .sub { margin-top: 0; color: #555; }

    .cards { display: flex; gap: 14px; margin: 18px 0; flex-wrap: wrap; }
    .card {
      background: white;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 14px 16px;
      min-width: 240px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .card .label { color: #666; font-size: 12px; text-transform: uppercase; }
    .card .value { font-size: 22px; margin-top: 6px; }
    .muted { color: #777; font-size: 12px; margin-top: 6px; }

    table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background: #222; color: white; }

    .high { color: green; font-weight: bold; }
    .medium { color: orange; font-weight: bold; }
    .low { color: gray; }

    .win { color: green; font-weight: bold; }
    .loss { color: #c62828; font-weight: bold; }
    .pending { color: #666; }
  </style>
</head>

<body>

<h1>üèÄ NCAA Halftime Prediction Analysis</h1>
<p class="sub">Live model output & historical performance</p>

<!-- ========================= -->
<!-- Overall Model Accuracy Stats -->
<!-- ========================= -->
<div class="cards">
  <div class="card" id="overallCard">
    <div class="label">Overall Record</div>
    <div class="value">Loading‚Ä¶</div>
    <div class="muted"></div>
  </div>
</div>

<!-- ========================= -->
<!-- Live Games -->
<!-- ========================= -->
<h2>Live & In-Progress Games</h2>
<table id="live-games">
  <thead>
    <tr>
      <th>Game</th>
      <th>Score</th>
      <th>Status</th>
      <th>Start</th>
      <th>Home Win %</th>
      <th>Confidence</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6">Loading‚Ä¶</td></tr>
  </tbody>
</table>

<!-- ========================= -->
<!-- Recent Completed -->
<!-- ========================= -->
<h2 id="recent-title">Most Recent Completed Games</h2>
<table id="recent-games">
  <thead>
    <tr>
      <th>Game</th>
      <th>Final</th>
      <th>Prediction</th>
      <th>Result</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="4">Loading‚Ä¶</td></tr>
  </tbody>
</table>

<script>

/* ---------------------------
   Helpers
--------------------------- */
function formatTime(iso) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}

/* ---------------------------
   Metrics
--------------------------- */
async function loadOverallMetrics() {
  const card = document.getElementById("overallCard");
  const value = card.querySelector(".value");
  const muted = card.querySelector(".muted");

  try {
    const res = await fetch("/metrics/overall");
    const m = await res.json();

    value.textContent = `${m.wins}-${m.losses}`;
    muted.textContent = m.accuracy !== null
      ? `Accuracy: ${(m.accuracy * 100).toFixed(1)}%`
      : "Accuracy: ‚Äî";
  } catch {
    value.textContent = "Error";
    muted.textContent = "";
  }
}

/* ---------------------------
   Live Games
--------------------------- */
async function loadLiveGames() {
  const tbody = document.querySelector("#live-games tbody");
  tbody.innerHTML = "";

  const res = await fetch("/games/live");
  const games = await res.json();

  if (games.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5">No games currently live.</td></tr>`;
    return;
  }

  for (const g of games) {
    let confClass = "pending";
    if (g.confidence !== null) {
      confClass =
        g.confidence >= 0.2 ? "high" :
        g.confidence >= 0.1 ? "medium" : "low";
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${g.away_name} @ ${g.home_name}</td>
      <td>${g.away_score} - ${g.home_score}</td>
      <td>${g.status}</td>
      <td>${formatTime(g.start_time_utc)}</td>
      <td>${g.predicted_home_win_prob !== null ? (g.predicted_home_win_prob * 100).toFixed(1) + "%" : "‚Äî"}</td>
      <td class="${confClass}">${g.confidence !== null ? g.confidence.toFixed(3) : "‚Äî"}</td>
    `;
    tbody.appendChild(row);
  }
}

/* ---------------------------
   Recent Completed
--------------------------- */
async function loadRecentGames() {
  const title = document.getElementById("recent-title");
  const tbody = document.querySelector("#recent-games tbody");
  tbody.innerHTML = "";

  const res = await fetch("/games/recent");
  const data = await res.json();

  if (!data.games || data.games.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4">No completed games yet.</td></tr>`;
    return;
  }

  title.textContent = `Most Recent Completed Games (${data.sports_day})`;

  for (const g of data.games) {
    let resultText = "‚è≥ Pending";
    let resultClass = "pending";
    if (g.prediction_correct === 1) { resultText = "‚úÖ Win"; resultClass = "win"; }
    if (g.prediction_correct === 0) { resultText = "‚ùå Loss"; resultClass = "loss"; }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${g.away_name} @ ${g.home_name}</td>
      <td>${g.away_final_score} - ${g.home_final_score}</td>
      <td>${(g.predicted_home_win_prob * 100).toFixed(1)}%</td>
      <td class="${resultClass}">${resultText}</td>
    `;
    tbody.appendChild(row);
  }
}

async function loadConfidenceBreakdown() {
  const res = await fetch("/metrics/confidence");
  const data = await res.json();

  for (const b of data) {
    const acc = b.wins + b.losses > 0
      ? (b.wins / (b.wins + b.losses) * 100).toFixed(1)
      : "‚Äî";

    console.log(`${b.confidence_bucket}: ${acc}%`);
  }
}

/* ---------------------------
   Boot
--------------------------- */
async function refreshAll() {
  await loadOverallMetrics();
  await loadLiveGames();
  await loadRecentGames();
}

refreshAll();
setInterval(refreshAll, 60000);
</script>

</body>
</html>
